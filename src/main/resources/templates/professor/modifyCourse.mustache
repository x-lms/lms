<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>학습관리시스템</title>
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/modifyCourse.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
{{#msg}}
<script>
    alert("{{msg}}");
</script>
{{/msg}}

<div class="main-content">
    <h2>강의 수정</h2>

    <div class="form-container">
        <form action="{{springMacroRequestContext.request.contextPath}}/professor/modifyCourse" method="post">
            
            <!-- PK 유지용 hidden -->
            <input type="hidden" name="newCourse.courseNo" value="{{cwt.newCourse.courseNo}}">

            <div class="form-group">
                <label>강의명 <span class="required">*</span></label>
                <input type="text" class="form-input" name="newCourse.courseName" value="{{cwt.newCourse.courseName}}" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>학과번호</label>
                    <input type="number" class="form-input" name="newCourse.deptNo" value="{{loginProfessor.deptNo}}" readonly>
                </div>
                <div class="form-group">
                    <label>정원</label>
                    <input type="number" class="form-input" name="newCourse.maxCnt" value="{{cwt.newCourse.maxCnt}}" required>
                </div>
            </div>

            <div class="form-group">
                <label>강의 시작일 <span class="required">*</span></label>
                <input type="date" class="form-input" id="startDate">
            </div>
            
            <div class="form-group">
                <label>강의 종료일 <span class="required">*</span></label>
                <input type="date" class="form-input" id="endDate">
            </div>
            
            <!-- 서버로 전송할 hidden input -->
            <input type="hidden" name="newCourse.coursePeriod" id="coursePeriod">

            <div class="form-group">
                <label>강의시간(요일, 시작시간, 종료시간) / 위치 <span class="required">*</span></label>
                <div id="courseTimeContainer">
                    {{#cwt.courseTimes}}
                    <div class="form-row courseTimeRow">
                        <select class="form-input" name="courseTimes[{{index}}].coursedate" required>
                            {{{dayOptions}}}
                        </select>
                        <input type="time" class="form-input" name="courseTimes[{{index}}].courseTimeStart" value="{{courseTimeStart}}" required>
                        <input type="time" class="form-input" name="courseTimes[{{index}}].courseTimeEnd" value="{{courseTimeEnd}}" required>
                        <input type="text" class="form-input" name="courseTimes[{{index}}].courseLocation" value="{{courseLocation}}" placeholder="강의실 위치" required>
                    </div>
                    {{/cwt.courseTimes}}
                </div>

                <div class="timeButtons">
                    <button type="button" id="addTimeBtn">+</button>
                    <button type="button" id="removeTimeBtn">-</button>
                </div>
            </div>

            <div class="form-group">
                <label>강의 계획</label>
                <textarea class="form-textarea" name="newCourse.coursePlan" placeholder="강의 계획을 입력하세요">{{cwt.newCourse.coursePlan}}</textarea>
            </div>

            <div class="button-group">
                <a href="{{springMacroRequestContext.request.contextPath}}/professor/courseOne?courseNo={{cwt.newCourse.courseNo}}" class="cancel-btn">취소</a>
                <button type="submit" class="submit-btn">수정</button>
            </div>
        </form>
    </div>
</div>

<script>
$(document).ready(function() {
    // 제출 시 유효성 검사
    $("form").on("submit", function(e) {
        const startDateVal = $("#startDate").val();
        const endDateVal = $("#endDate").val();

        if (!startDateVal || !endDateVal) {
            alert("강의 시작일과 종료일을 모두 입력해주세요.");
            e.preventDefault();
            return false;
        }

        const startDate = new Date(startDateVal);
        const endDate = new Date(endDateVal);

        if (startDate > endDate) {
            alert("강의 시작일이 종료일보다 클 수 없습니다.");
            e.preventDefault();
            return false;
        }

        // 서버로 보낼 hidden input에 합치기
        $("#coursePeriod").val(`${startDateVal} ~ ${endDateVal}`);
    });

    // 강의시간 추가/삭제
    $('#addTimeBtn').on('click', function() {
        const index = $('#courseTimeContainer .courseTimeRow').length;
        const $clone = $('#courseTimeContainer .courseTimeRow:last').clone();

        $clone.find('select').attr('name', `courseTimes[${index}].coursedate`);
        $clone.find('input[name$="courseTimeStart"]').attr('name', `courseTimes[${index}].courseTimeStart`);
        $clone.find('input[name$="courseTimeEnd"]').attr('name', `courseTimes[${index}].courseTimeEnd`);
        $clone.find('input[name$="courseLocation"]').attr('name', `courseTimes[${index}].courseLocation`);
        $clone.find('input').val('');
        $('#courseTimeContainer').append($clone);
    });

    $('#removeTimeBtn').on('click', function() {
        if ($('#courseTimeContainer .courseTimeRow').length > 1) {
            $('#courseTimeContainer .courseTimeRow:last').remove();
        } else {
            alert("최소 한 개의 강의시간은 필요합니다.");
        }
    });
});
</script>
</body>
</html>
