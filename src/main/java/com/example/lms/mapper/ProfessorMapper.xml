<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.ProfessorMapper">
	
	<!-- 최종 성적 -->
	<update id="modifyFinalScore" parameterType="com.example.lms.dto.Score">
		update score	
		set score_grade = #{scoreGrade},
			score_status = #{scoreStatus}
		where student_no = #{studentNo} and course_no = #{courseNo}	
	</update>
	
	<!-- 과제점수 평균 -->
	<select id="getAvgProjectScoreByStudent" parameterType="int" resultType="com.example.lms.dto.ProjectAverage">
	    SELECT 
	        s.student_no AS studentNo,
	        s.student_name AS studentName,
	        IFNULL(AVG(pr.result_score), 0) AS avgProjectScore
	    FROM student s
	    JOIN registration r 
	        ON s.student_no = r.student_no
	    LEFT JOIN project p 
	        ON r.course_no = p.course_no
	    LEFT JOIN project_result pr 
	        ON p.project_no = pr.project_no
	        AND s.student_no = pr.student_no
	    WHERE r.course_no = #{courseNo}
	      AND s.student_no = #{studentNo}
	    GROUP BY s.student_no
	</select>
	
	<!-- 성적 등록(grade) -->
	<update id="updateScoreGrade" parameterType="com.example.lms.dto.Score">
	    UPDATE score
	    SET score_grade = #{scoreGrade}
	    WHERE student_no = #{studentNo} AND course_no = #{courseNo}
	</update>
	
	<!-- 성적등록 확인 -->
	<select id="existsScore" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM score
        WHERE student_no = #{studentNo} 
          AND course_no = #{courseNo}    
    </select>
		
	<!-- 성적 등록 -->
	<insert id="addScore" parameterType="com.example.lms.dto.Score">
		insert into score
			(student_no, emp_no, course_no, score_att, score_project, score_mid, score_fin, score_total, score_grade)
		values(#{studentNo}, #{empNo}, #{courseNo}, #{scoreAtt}, #{scoreProject}, #{scoreMid}, #{scoreFin}, #{scoreTotal}, #{scoreGrade})
	</insert>
	
	<!-- 성적 등록 폼 (점수존재여부조회) -->
	<select id="getStudentListAndScore" parameterType="int" resultType="com.example.lms.dto.StudentScorePF">
		SELECT
	        r.regist_no registNo,
	        r.course_no courseNo,
	        s.student_no studentNo,
	        s.student_name studentName,
	        IFNULL(sc.score_att,0) scoreAtt,
	        IFNULL(sc.score_project,0) scoreProject,
	        IFNULL(sc.score_mid,0) scoreMid,
	        IFNULL(sc.score_fin,0) scoreFin,
	        (sc.student_no IS NOT NULL) existsScore
	    FROM registration r
	    JOIN student s ON s.student_no = r.student_no
	    LEFT JOIN score sc ON sc.student_no = r.student_no AND sc.course_no = r.course_no
	    WHERE r.course_no = #{courseNo}
	</select>
	
	<!-- 성적 목록 -->
	<select id="getScoreByCourse" parameterType="int" resultType="com.example.lms.dto.Score">
		 SELECT
	        sc.score_no scoreNo,
	        sc.student_no studentNo,
	        s.student_name studentName,
	        sc.emp_no empNo,
	        sc.course_no courseNo,
	        sc.score_att scoreAtt,
	        sc.score_project scoreProject,
	        sc.score_mid scoreMid,
	        sc.score_fin scoreFin,
	        sc.score_total scoreTotal,
	        sc.score_grade scoreGrade,
	        sc.score_status scoreStatus
	    FROM score sc
	    LEFT JOIN student s
	    	ON sc.student_no = s.student_no
	    WHERE sc.course_no = #{courseNo}
	    ORDER BY sc.score_total DESC
	</select>
		
	<!-- 답글 등록 -->
	<update id="updateAnswer" parameterType="com.example.lms.dto.Question">
		update question
		set 
			answer_contents = #{answerContents},
			answer_status = #{answerStatus}
		where question_no = #{questionNo}	
	</update>
	
	<!-- 문의사항 목록 -->
	<select id="questionListByPage" parameterType="map" resultType="com.example.lms.dto.Question">
		select
			q.question_no questionNo,
			q.student_no studentNo,
			q.emp_no empNo,
			q.course_no courseNo,
			c.course_name courseName,
			q.question_title questionTitle,
			q.question_contents questionContents,
			IFNULL(q.answer_status, 'N') answerStatus,
			q.answer_contents answerContents,
			q.createdate
		from question q
		left join course c
		on q.course_no = c.course_no
		where q.emp_no = #{empNo}
		order by q.createdate desc
		limit #{beginRow}, #{rowPerPage}
	</select>

	<select id="getQuestionCount" parameterType="map" resultType="int">
		select count(*) from question where emp_no = #{empNo}
	</select>
	
	<!-- 과제 점수 등록 -->
	<update id="addResultScore" parameterType="com.example.lms.dto.ProjectResult">
		update project_result 
		set 
			result_score = #{resultScore}
		where result_no = #{resultNo}		 
	</update>
	
	<!-- 결과물 상세보기 -->
	<select id="projectResultOne" parameterType="int" resultType="com.example.lms.dto.ProjectResult">
		select
			pr.result_no resultNo,
			pr.project_no projectNo,
			pr.student_no studentNo,
			s.student_name studentName,
			pr.result_title resultTitle,
			pr.result_contents resultContents,
			pr.result_file resultFile,
			pr.result_score resultScore,
			pr.createdate
		from project_result pr
		left join student s
		on pr.student_no = s.student_no
		where pr.result_no = #{resultNo}	
	</select>
	
	<!-- 과제 결과물 목록 -->
	<select id="projectResultList" parameterType="int" resultType="com.example.lms.dto.ProjectResult">
		select
			result_no resultNo,
			project_no projectNo,
			student_no studentNo,
			result_title resultTitle,
			result_score resultScore,
			createdate
		from project_result
		where project_no = #{projectNo}
		order by createdate desc		
	</select>
	
	<!-- 과제삭제 -->
	<delete id="deleteProjectIfNoResults" parameterType="int">
		DELETE FROM project WHERE project_no = #{projectNo}
	</delete>

	<!-- 과제 결과물 개수 확인 -->
	<select id="countProjectResults" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM project_result WHERE project_no = #{projectNo}
	</select>
	
	<!-- 과제등록 -->
	<insert id="addProject">
		insert into project(course_no, project_name, emp_no, project_deadline)
		values(#{courseNo}, #{projectName}, #{empNo}, #{projectDeadline})
	</insert>
	
	<!-- 과제목록 -->
	<select id="projectListByPage" parameterType="map" resultType="com.example.lms.dto.Project">
		select 
			p.project_no projectNo,
			p.course_no courseNo,
			c.course_name courseName,
			p.project_name projectName,
			p.emp_no empNo,
			p.project_deadline projectDeadline
		from project p 
		inner join course c
		on p.course_no = c.course_no
		where p.emp_no = #{empNo}
		order by p.project_no desc
		limit #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getProjectCount" parameterType="map" resultType="int">
		select count(*)
		from project
		where emp_no = #{empNo}
	</select>
	
	<!-- 출석수정 -->
	<update id="updateHistory" parameterType="com.example.lms.dto.AttendanceHistory">
		UPDATE attendance_history
	    SET
	        state_after = #{stateAfter},
	        history_comment = #{historyComment},
	        history_file = #{historyFile},
	        history_file_original = #{historyFileOriginal}
	    WHERE history_no = #{historyNo};
	</update>
	
	<update id="updateAttendanceFromUpdateHistory" parameterType="com.example.lms.dto.AttendanceHistory">
	    UPDATE attendance
	    SET
	        att_state= #{stateAfter}
	    WHERE att_no = #{attNo};
	</update>
	
	<select id="getHistoryByHN" parameterType="int" resultType="com.example.lms.dto.AttendanceHistory">
		SELECT
		  	history_no historyNo,
	        att_no attNo,
	        course_no courseNo,
	        state_before stateBefore,
	        COALESCE(state_after, '') stateAfter,
	        COALESCE(history_comment, '') historyComment,
	       	history_file historyFile,
	        createdate
		FROM attendance_history
		WHERE history_no = #{historyNo}
	</select>
	
	<!-- 출석내역목록 -->
	<select id="attendanceHistoryList" parameterType="map" resultType="com.example.lms.dto.AttendanceHistory">
	    SELECT
	        h.history_no historyNo,
	        h.att_no attNo,
	        a.course_no courseNo,
	        s.student_no studentNo,
	        s.student_name studentName,
	        h.state_before stateBefore,
	        COALESCE(h.state_after, '-') stateAfter,
	        COALESCE(h.history_comment, '') historyComment,
	        h.history_file historyFile,
	        h.history_file_original historyFileOriginal,
	        h.createdate
	    FROM attendance_history h
	    JOIN attendance a ON h.att_no = a.att_no
	    JOIN student s ON a.student_no = s.student_no
	    <where>
	        <if test="courseNo != null">
	            a.course_no = #{courseNo}
	        </if>
	        <if test="studentName != null and studentName != ''">
	            s.student_name LIKE CONCAT('%', #{studentName}, '%')
	        </if>
	    </where>
	    ORDER BY h.history_no DESC
	    LIMIT #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getHistoryCount" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM attendance_history h
	    JOIN attendance a ON h.att_no = a.att_no
	    JOIN student s ON a.student_no = s.student_no
	    <where>
	        <if test="courseNo != null">
	            a.course_no = #{courseNo}
	        </if>
	        <if test="studentName != null and studentName != ''">
	            s.student_name LIKE CONCAT('%', #{studentName}, '%')
	        </if>
	    </where>
	</select>

	<!-- 출석체크 -->
	<insert id="insertAttendance" parameterType="com.example.lms.dto.Attendance" useGeneratedKeys="true" keyProperty="attNo">
		INSERT INTO attendance(student_no, course_no, emp_no, att_date, att_state)
		VALUES (#{studentNo}, #{courseNo}, #{empNo}, SYSDATE(), #{attState});
	</insert>	
	
	<insert id="insertHistoryFromAddAttendance" parameterType="com.example.lms.dto.Attendance">
	    INSERT INTO attendance_history(att_no, course_no, state_before)
	    VALUES (#{attNo}, #{courseNo}, #{attState})  
	</insert>
	
	<!-- 출석체크(하루제한) -->
	<select id="countAttendanceToday" resultType="int">
	    SELECT COUNT(*)
	    FROM attendance
	    WHERE student_no = #{studentNo}
	      AND course_no = #{courseNo}
	      AND att_date = #{today}
	</select>
	
	<!-- 출석체크(학생리스트) -->
	<select id="getStudentListByCourse" parameterType="int" resultType="com.example.lms.dto.CourseStudent">
	    SELECT 
	        r.course_no courseNo,
	        s.student_no studentNo,
	        s.student_name studentName,
	        COALESCE(s.student_email, '-') studentEmail,
	        COALESCE(s.student_phone, '-') studentPhone,
	        s.student_state studentState,
	        s.student_img studentImg
	    FROM student s
	    JOIN registration r 
	    	ON s.student_no = r.student_no
	    WHERE r.course_no = #{courseNo}
	    ORDER BY s.student_name ASC
	</select>
	
	<!-- 총 출결상태 -->	
	<select id="getAttendanceSummaryByCourse" parameterType="int" resultType="com.example.lms.dto.AttendanceSummary">
	    SELECT 
	        r.student_no studentNo,
	        COUNT(a.att_no) total,                     
	        SUM(CASE WHEN a.att_state = '출석' THEN 1 ELSE 0 END) attendance,
	        SUM(CASE WHEN a.att_state = '결석' THEN 1 ELSE 0 END) absent,
	        SUM(CASE WHEN a.att_state = '지각' THEN 1 ELSE 0 END) late
	    FROM registration r
	    LEFT JOIN attendance a 
	    ON r.student_no = a.student_no AND r.course_no = a.course_no
	    WHERE r.course_no = #{courseNo}
	    GROUP BY r.student_no
	</select>		
			
	<!-- 출석체크(강의목록) -->	
	<select id="getCourseAttandanceAndScore" parameterType="map" resultType="com.example.lms.dto.Course">
		select
			course_no courseNo, course_name courseName, dept_no deptNo,
			emp_no empNo, max_cnt maxCnt, current_cnt currentCnt,
			course_period coursePeriod, course_plan coursePlan 
		from course
		where emp_no = #{empNo}
	</select>
	
	<!-- 학생리스트 -->
	<select id="studentListByPage" parameterType="map" resultType="com.example.lms.dto.Student">
		SELECT
		    s.student_no studentNo,
		    s.dept_no deptNo,
		    d.dept_name deptName,
		    s.student_pw studentPw,
		    s.student_name studentName,
		    s.student_state studentState,
		    COALESCE(s.student_address, '-') studentAddress,
		    COALESCE(s.student_phone, '-') studentPhone,
		    COALESCE(s.student_birth, '-') studentBirth,
		    s.student_img studentImg,
		    COALESCE(s.student_email, '-') studentEmail
		FROM student s
		JOIN dept d ON s.dept_no = d.dept_no
		where s.dept_no = #{deptNo}
			<if test="searchWord != null and searchWord != ''">
			 and student_name like concat('%', #{searchWord},'%')
			</if>
		order by s.student_name asc
		limit #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getStudentCount" parameterType="map" resultType="int">
	    select count(*)
	    from student
	    <where>
	        dept_no = #{deptNo}
	        <if test="searchWord != null and searchWord != ''">
	            and student_name like concat('%', #{searchWord},'%')
	        </if>
	    </where>
	</select>
	
	<!-- 강의 삭제 -->
	<delete id="deleteCourse" parameterType="int">
	    DELETE FROM course
	    WHERE course_no = #{courseNo};
	</delete>

	<delete id="deleteCourseTime" parameterType="int">
	    DELETE FROM course_time
	    WHERE course_no = #{courseNo};
	</delete>
	
	<!-- 강의 수정 -->
	<update id="updateCourse" parameterType="com.example.lms.dto.Course">
	    UPDATE course
	    SET
	        course_name = #{courseName},
	        max_cnt = #{maxCnt},
	        course_period = #{coursePeriod},
	        course_plan = #{coursePlan}
	    WHERE course_no = #{courseNo};
	</update>	
	
	<select id="getCourseTime" parameterType="int" resultType="com.example.lms.dto.CourseTime">
		SELECT
	        course_time_no courseTimeNo,
	        course_no courseNo,
	        course_location courseLocation, 
	        course_date coursedate, 
	        course_time_start courseTimeStart, 
	        course_time_end courseTimeEnd
	    FROM course_time
	    WHERE course_no = #{courseNo};
	</select> 
	
	<insert id="addCourseTime" parameterType="com.example.lms.dto.CourseTime">
	   insert into course_time(course_no, course_location, course_date, course_time_start, course_time_end)
	   value(#{courseNo}, #{courseLocation}, #{coursedate}, #{courseTimeStart}, #{courseTimeEnd})
	</insert>
	
	<!-- 강의 상세보기 -->
	<select id="courseOne" parameterType="int" resultType="com.example.lms.dto.Course">
		SELECT
	        course_no courseNo, course_name courseName, dept_no deptNo,
	        emp_no empNo, max_cnt maxCnt, current_cnt currentCnt,
	        course_period coursePeriod, course_plan coursePlan
	    FROM course
	    WHERE course_no = #{courseNo};
	</select>
	
	<select id="getCourseTimeList" parameterType="int" resultType="com.example.lms.dto.CourseTime">
		SELECT
	        course_time_no courseTimeNo, course_no courseNo,
	        course_location courseLocation, course_date coursedate, 
	        course_time_start courseTimeStart, course_time_end courseTimeEnd
	    FROM course_time
	    WHERE course_no = #{courseNo};
	</select> 
		
	<!-- 강의등록 -->
	<insert id="insertCourse" parameterType="com.example.lms.dto.Course" useGeneratedKeys="true" keyProperty="courseNo">
		insert into course
			(course_name, dept_no, emp_no, max_cnt, current_cnt, course_period, course_plan)
		values
			(#{courseName}, #{deptNo}, #{empNo}, #{maxCnt}, 0, #{coursePeriod}, #{coursePlan})
	</insert>

	<insert id="insertCourseTime" parameterType="com.example.lms.dto.CourseWithTime">
		insert into course_time
			(course_no, course_location, course_date, course_time_start, course_time_end)
		values
			 <foreach collection="courseTimes" item="time" separator=",">
		        (#{time.courseNo}, #{time.courseLocation}, #{time.coursedate}, #{time.courseTimeStart}, #{time.courseTimeEnd})
		    </foreach>
	</insert>
	
	<!-- 교수별 등록된 강의시간 조회 -->
	<select id="getCourseTimesByEmp" parameterType="int" resultType="com.example.lms.dto.CourseTime">
		SELECT
	        ct.course_time_no courseTimeNo,
	        ct.course_no courseNo,
	        ct.course_date coursedate,     
	        ct.course_time_start courseTimeStart,
	        ct.course_time_end courseTimeEnd,
	        ct.course_location courseLocation
	    FROM course_time ct
	    JOIN course c ON c.course_no = ct.course_no
	    WHERE c.emp_no = #{empNo}
	</select>
	
	<!-- 강의리스트 -->	
	<select id="courseListByPage" parameterType="map" resultType="com.example.lms.dto.Course">
		select
			c.course_no courseNo, 
			c.course_name courseName, 
			d.dept_Name deptName,
			e.emp_name empName,
			c.max_cnt maxCnt,
			c.current_cnt currentCnt,
			c.course_period coursePeriod,
			c.course_plan coursePlan 
		from course c
		left join dept d
			on c.dept_no = d.dept_no
		left join emp e
			on c.emp_no = e.emp_no
		where c.emp_no = #{empNo}
			<if test="searchWord != null and searchWord != ''">
			 and c.course_name like concat('%', #{searchWord},'%')
			</if>
		order by c.course_no desc
	</select>
	
	<select id="getCourseCount" parameterType="Map" resultType="int">
		select count(*)
		from course
		<where>
			<if test="searchWord != null and searchWord != ''">
				course_name like concat('%', #{searchWord},'%')
			</if>
		</where>
	</select>
	
	<!-- 내 정보 수정 -->
	<update id="updateProfessorInfo" parameterType="com.example.lms.dto.Emp">
		update emp
		set dept_no = #{deptNo},
			emp_pw = #{empPw},
			emp_name = #{empName},
			emp_birth = #{empBirth},
			emp_phone = #{empPhone},
			emp_img = #{empImg}		
		where emp_No = #{empNo}
	</update> 
	
	<!-- 내 정보 -->
	<select id="professorInfo" parameterType="int" resultType="com.example.lms.dto.Emp">
		select 
			emp_no empNo, dept_no deptNo,
			emp_name empName, emp_email empEmail, emp_pw empPw,
			emp_birth empBirth, emp_phone empPhone, emp_img empImg 
		from emp
		where emp_no = #{empNo}
	</select>

	<!-- 교수 시간표(홈 화면) -->
	<select id="selectAllCourseTimes" parameterType="int" resultType="com.example.lms.dto.CourseTime">
	    SELECT 
	        ct.course_time_no courseTimeNo,
	        c.course_name courseName,
	        ct.course_location courseLocation,
	        ct.course_date coursedate,
	        ct.course_time_start courseTimeStart,
	        ct.course_time_end courseTimeEnd
	    FROM course_time ct
	    JOIN course c ON ct.course_no = c.course_no
	    WHERE c.emp_no = #{empNo}
	    ORDER BY ct.course_time_start
	</select>
	
</mapper>