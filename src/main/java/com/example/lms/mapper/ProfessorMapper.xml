<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.lms.mapper.ProfessorMapper">
	
	<!-- 출석수정 -->
	<update id="updateHistory" parameterType="com.example.lms.dto.AttendanceHistory">
		UPDATE attendance_history
	    SET
	        state_after = #{stateAfter},
	        history_comment = #{historyComment},
	        history_file = #{historyFile}
	    WHERE history_no = #{historyNo};
	</update>
	
	<update id="updateAttendanceFromUpdateHistory" parameterType="com.example.lms.dto.AttendanceHistory">
	    UPDATE attendance
	    SET
	        att_state= #{stateAfter}
	    WHERE att_no = #{attNo};
	</update>
	
	<select id="getHistoryByHN" parameterType="int" resultType="com.example.lms.dto.AttendanceHistory">
		SELECT
		  	history_no historyNo,
	        att_no attNo,
	        course_no courseNo,
	        state_before stateBefore,
	        COALESCE(state_after, '') stateAfter,
	        COALESCE(history_comment, '') historyComment,
	       	history_file historyFile,
	        createdate
		FROM attendance_history
		WHERE history_no = #{historyNo}
	</select>
	
	<!-- 출석내역목록 -->
	<select id="attendanceHistoryList" parameterType="map" resultType="com.example.lms.dto.AttendanceHistory">
		SELECT
		  	history_no historyNo,
	        att_no attNo,
	        course_no courseNo,
	        state_before stateBefore,
	        COALESCE(state_after, '') stateAfter,
	        COALESCE(history_comment, '') historyComment,
	       	history_file historyFile,
	        createdate
		FROM attendance_history
		<where>
	        <if test="attNo != null">
	            att_no = #{attNo}
	        </if>
	    </where>
		order by att_no desc
		limit #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getHistoryCount" parameterType="map" resultType="int">
		select count(*)
		from attendance_history
		<where>
	        <if test="attNo != null">
	            att_no = #{attNo}
	        </if>
	    </where>
	</select>
	
	<!-- 출석체크 -->
	<insert id="insertAttendance" parameterType="com.example.lms.dto.Attendance" useGeneratedKeys="true" keyProperty="attNo">
		INSERT INTO attendance(student_no, course_no, emp_no, att_date, att_state)
		VALUES (#{studentNo}, #{courseNo}, #{empNo}, SYSDATE(), #{attState});
	</insert>	
	
	<insert id="insertHistoryFromAddAttendance" parameterType="com.example.lms.dto.Attendance">
	    INSERT INTO attendance_history(att_no, course_no, state_before)
	    VALUES (#{attNo}, #{courseNo}, #{attState})  
	</insert>
	
	<!-- 출석체크(학생리스트) -->
	<select id="getStudentListByCourse" parameterType="int" resultType="com.example.lms.dto.CourseStudent">
	    SELECT 
	        cs.course_no courseNo,
	        s.student_no studentNo,
	        s.student_name studentName,
	        s.student_email studentEmail,
	        s.student_phone studentPhone,
	        s.student_state studentState,
	        s.student_img studentImg
	    FROM student s
	    JOIN course_student cs ON s.student_no = cs.student_no
	    WHERE cs.course_no = #{courseNo}
	    ORDER BY s.student_name ASC
	</select>
			
	<!-- 출석체크(강의목록) -->	
	<select id="getAttandance" parameterType="map" resultType="com.example.lms.dto.Course">
		select
			course_no courseNo, course_name courseName, dept_no deptNo,
			emp_no empNo, max_cnt maxCnt, current_cnt currentCnt,
			course_period coursePeriod, course_plan coursePlan 
		from course
		where emp_no = #{empNo}
	</select>
	
	<!-- 학생리스트 -->
	<select id="studentListByPage" parameterType="map" resultType="com.example.lms.dto.Student">
		SELECT
		    student_no studentNo,
		    dept_no deptNo,
		    student_pw studentPw,
		    student_name studentName,
		    student_state studentState,
		    student_address studentAddress,
		    student_phone studentPhone,
		    student_birth studentBirth,
		    student_img studentImg,
		    student_email studentEmail
		FROM student
		where dept_no = #{deptNo}
			<if test="searchWord != null and searchWord != ''">
			 and student_name like concat('%', #{searchWord},'%')
			</if>
		order by student_name asc
		limit #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getStudentCount" parameterType="Map" resultType="int">
		select count(*)
		from student
		<where>
			<if test="searchWord != null and searchWord != ''">
				student_name like concat('%', #{searchWord},'%')
			</if>
		</where>
	</select>
	
	<!-- 강의 삭제 -->
	<delete id="deleteCourse" parameterType="int">
	    DELETE FROM course
	    WHERE course_no = #{courseNo};
	</delete>
	
	<!-- 강의 수정 -->
	<update id="updateCourse" parameterType="com.example.lms.dto.Course">
	    UPDATE course
	    SET
	        course_name = #{courseName},
	        max_cnt = #{maxCnt},
	        course_period = #{coursePeriod},
	        course_plan = #{coursePlan}
	    WHERE course_no = #{courseNo};
	</update>	
	
	<!-- 강의 상세보기 -->
	<select id="courseOne" parameterType="int" resultType="com.example.lms.dto.Course">
		SELECT
	        course_no courseNo, course_name courseName, dept_no deptNo,
	        emp_no empNo, max_cnt maxCnt, current_cnt currentCnt,
	        course_period coursePeriod, course_plan coursePlan
	    FROM course
	    WHERE course_no = #{courseNo};
	</select>
		
	<!-- 강의등록 -->
	<insert id="insertCourse" parameterType="com.example.lms.dto.Course" useGeneratedKeys="true" keyProperty="courseNo">
		insert into course
			(course_name, dept_no, emp_no, max_cnt, current_cnt, course_period, course_plan)
		values
			(#{courseName}, #{deptNo}, #{empNo}, #{maxCnt}, 0, #{coursePeriod}, #{coursePlan})
	</insert>
	
	<!-- 강의리스트 -->	
	<select id="courseListByPage" parameterType="map" resultType="com.example.lms.dto.Course">
		select
			course_no courseNo, course_name courseName, dept_no deptNo,
			emp_no empNo, max_cnt maxCnt, current_cnt currentCnt,
			course_period coursePeriod, course_plan coursePlan 
		from course
		where emp_no = #{empNo}
			<if test="searchWord != null and searchWord != ''">
			 and course_name like concat('%', #{searchWord},'%')
			</if>
		order by course_no desc
		limit #{beginRow}, #{rowPerPage}
	</select>
	
	<select id="getCourseCount" parameterType="Map" resultType="int">
		select count(*)
		from course
		<where>
			<if test="searchWord != null and searchWord != ''">
				course_name like concat('%', #{searchWord},'%')
			</if>
		</where>
	</select>
	
	<!-- 내 정보 수정 -->
	<update id="updateProfessorInfo" parameterType="com.example.lms.dto.Emp">
		update emp
		set dept_no = #{deptNo},
			emp_pw = #{empPw},
			emp_name = #{empName},
			emp_birth = #{empBirth},
			emp_phone = #{empPhone},
			emp_img = #{empImg}		
		where emp_No = #{empNo}
	</update> 
	
	<!-- 내 정보 -->
	<select id="professorInfo" parameterType="int" resultType="com.example.lms.dto.Emp">
		select 
			emp_no empNo, dept_no deptNo,
			emp_name empName, emp_email empEmail, emp_pw empPw,
			emp_birth empBirth, emp_phone empPhone, emp_img empImg 
		from emp
		where emp_no = #{empNo}
	</select>

</mapper>